---
name: Kong Global configuration
on:
  push:
    branches:
      - main
jobs:
  OAS_TO_Kong:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code from another repository
        uses: actions/checkout@v2
        with:
          repository: 'Ani-maurya/pipeline-data'
          ref: 'main'
          token: ${{ secrets.PAT }}

      - name: download jq
        run: |
          sudo apt install jq -y
          jq --version

      - name: download yq
        run: |
          sudo snap install yq
          yq --version

      - name: Install deck CLI
        run: |
          curl -sL https://github.com/kong/deck/releases/download/v1.35.0/deck_1.35.0_linux_amd64.tar.gz -o deck.tar.gz
          tar -xf deck.tar.gz -C /tmp 
          sudo cp /tmp/deck /usr/local/bin/

      - name: Append Plugins to New file
        run: >
            if [ "${{ vars.HTTP_LOG }}" == "true" || [ "${{ vars.CORRELATION_ID }}" == "true" ]; then
              sed -i '1,2d' correlation.yaml
              sed -i '1d' http-log.yaml
              cat  http-log.yaml correlation.yaml > combined-plugins.yaml
              cat combined-plugins.yaml
            fi

      - name: Set headers and run deck sync
        run: >
          deck gateway sync  --select-tag dev combined-plugins.yaml --konnect-token ${{ secrets.DECK_TOKEN }} --konnect-control-plane-name A-1
